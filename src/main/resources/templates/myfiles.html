<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main-layout :: document('My Uploaded Documents', ~{::content})}">

<div th:fragment="content">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
        /* === SHARED FORM STYLE (MATCH UPLOAD FORM) === */
        .form-container {
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            background-color: white;
            font-family: 'Montserrat', sans-serif;
        }

        .page-header {
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
            background: linear-gradient(135deg, #E8392F 0%, #cf2f27 100%);
        }

        .page-header h4,
        .page-header i {
            color: white;
            margin: 0;
            font-weight: 700;
        }

        .page-body {
            padding: 2rem;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #E8392F;
            text-transform: uppercase;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #fcebea;
        }

        /* === TABLE STYLE === */
        table thead th {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #495057;
            background-color: #f8f9fa;
        }

        table tbody td {
            font-size: 0.75rem;
            vertical-align: middle;
        }

        .filename {
            color: #6c757d;
            font-size: 0.7rem;
        }

        .viewer-badge {
            background-color: #fcebea;
            color: #E8392F;
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            font-weight: 600;
            border-radius: 4px;
        }

        .btn-outline-danger,
        .btn-outline-success {
            --bs-btn-hover-bg: transparent;
        }
        .btn-sm {
            padding: 0.2rem 0.45rem;
            font-size: 0.7rem;
        }

        .search-bar {
            max-width: 360px;
        }
    </style>

    <div class="form-container">

        <!-- HEADER -->
        <div class="page-header">
            <h4><i class="fas fa-folder-open me-2"></i>My Uploaded Documents</h4>
        </div>

        <!-- BODY -->
        <div class="page-body">

            <!-- SEARCH -->
            <div class="form-section d-flex justify-content-end">
                <form th:action="@{/myfiles/search}" method="get" class="search-bar">
                    <div class="input-group input-group-sm">
                        <input type="search" class="form-control"
                               name="query"
                               placeholder="Search documents...">
                        <button class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- DOCUMENT LIST -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-file-alt me-2"></i>Uploaded Files
                </div>

                <div th:if="${not #lists.isEmpty(documents)}" class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Classification</th>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Filename</th>
                            <th>Date</th>
                            <th>Uploaded By</th>
                            <th>Viewer Group</th>
                            <th class="text-center">Actions</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="doc, i : ${documents}">
                            <td th:text="${i.index + 1}"></td>

                            <td th:text="${doc.documentClassification.documentName}"></td>

                            <td th:text="${doc.title}"></td>

                            <td class="text-truncate" style="max-width: 220px"
                                th:text="${doc.description}"></td>

                            <td class="filename" th:text="${doc.filename}"></td>

                            <td th:text="${doc.uploadDate != null 
                                ? #temporals.format(doc.uploadDate, 'yyyy-MM-dd') 
                                : '-'}"></td>
                            <!-- NULL-SAFE FIX -->
                            <td th:text="${doc.uploadedBy != null ? doc.uploadedBy.username : 'System'}"></td>

                            <td>
                                <span class="viewer-badge"
                                      th:text="${doc.intendedViewerGroup}"></span>
                            </td>

                            <td class="text-center">
                                <a th:href="@{/download/{id}(id=${doc.id})}"
                                   class="btn btn-sm btn-outline-success me-1"
                                   title="Download">
                                    <i class="fas fa-download"></i>
                                </a>

                                <button class="btn btn-sm btn-outline-danger btn-delete"
                                        th:data-file-id="${doc.id}"
                                        title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- EMPTY STATE -->
                <div th:if="${#lists.isEmpty(documents)}"
                     class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    You have not uploaded any documents yet.
                </div>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION -->
    <script>
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.dataset.fileId;

                Swal.fire({
                    title: 'Delete this file?',
                    text: 'This action cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#E8392F',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, delete it'
                }).then(result => {
                    if (result.isConfirmed) {
                        window.location.href = '/delete/' + id;
                    }
                });
            });
        });
    </script>

</div>
</html>
