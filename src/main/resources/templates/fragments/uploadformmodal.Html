<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <style>
        .modal-content.custom-modal-style {
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
        }
        
        .modal-header {
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-body .row .col-md-6 .form-control[type="file"] {
            height: 100px; 
        }
    </style>
</head>
<body>
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true" th:fragment="uploadFormModalFragment">
        <div class="modal-dialog modal-xl">
            <div class="modal-content custom-modal-style">
                
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel"><i class="fas fa-cloud-upload-alt me-2 text-primary"></i>Upload New Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <form id="uploadDocumentForm" th:action="@{/save}" th:object="${uploadForm}" method="post" enctype="multipart/form-data">
                        
                        <div class="row">
                            
                            <div class="col-md-4 mb-3">
                                <label for="classificationId" class="form-label">Type of Document</label>
                                <select class="form-control" id="classificationId" th:field="*{class_id}" required>
                                    <option th:value="0">Select Document Type</option>
                                    <option th:value="1">PDF (.pdf)</option>
                                    <option th:value="2">Word Document (.doc)</option>
                                    <option th:value="3">Excel Spreadsheet (.xlsx)</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="title" th:field="*{title}" placeholder="Enter Title" required>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="dateCreated" class="form-label">Date Created</label>
                                <input type="text" class="form-control" id="dateCreated" th:field="*{date}" readonly style="background-color: #f8f9fa; color: #6c757d;">
                            </div>
    
                        </div>
                        
                        <div class="row">
    
                            <div class="col-md-6 mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" th:field="*{description}" rows="3" placeholder="Enter Description"></textarea>
                            </div>
    
                            <div class="col-md-6 mb-3 d-flex flex-column justify-content-end">
                                <label for="file" class="form-label">Select File</label>
                                <input type="file" class="form-control" id="file" name="file" accept=".pdf,.doc,.docx,.xlsx,.txt" required>
                            </div>
                            
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                Upload Document
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${yyyy}-${mm}-${dd}`;
            
            const dateCreatedElement = document.getElementById('dateCreated');
            if (dateCreatedElement) {
                dateCreatedElement.value = formattedDate;
            }
        });
    
        document.getElementById('uploadDocumentForm').addEventListener('submit', function(event) {
            event.preventDefault();
    
            const form = event.target;
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            const spinner = submitButton.querySelector('.spinner-border');
    
            submitButton.disabled = true;
            spinner.classList.remove('d-none');
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
    
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.json();
            })
            .then(data => {
                Swal.fire({
                    icon: 'success',
                    title: 'Upload Successful!',
                    text: data.message || 'Your document has been uploaded and saved.',
                    timer: 2000,
                    timerProgressBar: true,
                    showConfirmButton: false
                }).then(() => {
                    form.reset();
                    const bootstrapModal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
                    if (bootstrapModal) {
                        bootstrapModal.hide();
                    }
                    window.location.reload(); 
                });
            })
            .catch(error => {
                console.error('Upload error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Upload Failed!',
                    text: error.message || 'There was an error uploading your document. Please try again.',
                    confirmButtonText: 'OK'
                });
            })
            .finally(() => {
                submitButton.disabled = false;
                spinner.classList.add('d-none');
                submitButton.innerHTML = 'Upload Document';
            });
        });
    </script>
</body>
</html>